# Candidate Invitation System

## Overview
The candidate invitation system allows employers to invite AI-matched candidates to apply for specific job positions. This system tracks invitations, responses, and manages the hiring workflow.

## Database Schema

### Tables Involved

#### 1. `candidate_invitations`
```sql
CREATE TABLE public.candidate_invitations (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  job_id uuid not null,
  candidate_id uuid not null,
  status text not null default 'invited'::text,
  response text null,
  employer_id uuid not null,
  constraint candidate_invitations_pkey primary key (id),
  constraint candidate_invitations_employer_id_fkey foreign KEY (employer_id) references employer_profiles (id),
  constraint candidate_invitations_job_id_fkey foreign KEY (job_id) references jobs (id) on delete CASCADE,
  constraint candidate_invitations_candidate_id_fkey foreign KEY (candidate_id) references job_seeker_profiles (id) on delete CASCADE
);
```

#### 2. `employer_profiles`
```sql
CREATE TABLE public.employer_profiles (
  id uuid not null, -- Same as user ID (profiles.id)
  company_id uuid null,
  position text null,
  department text null,
  is_admin boolean null default false,
  -- ... other fields
  constraint employer_profiles_pkey primary key (id),
  constraint employer_profiles_id_fkey foreign KEY (id) references profiles (id)
);
```

#### 3. `companies`
```sql
CREATE TABLE public.companies (
  id uuid not null default extensions.uuid_generate_v4(),
  name text not null,
  created_by uuid not null,
  -- ... other fields
  constraint companies_pkey primary key (id),
  constraint companies_created_by_fkey foreign KEY (created_by) references profiles (id)
);
```

## Key Relationships

1. **User → Employer Profile**: `profiles.id` = `employer_profiles.id`
2. **Employer Profile → Company**: `employer_profiles.company_id` = `companies.id`
3. **Invitation → Employer**: `candidate_invitations.employer_id` = `employer_profiles.id` (user ID)
4. **Invitation → Job**: `candidate_invitations.job_id` = `jobs.id`
5. **Invitation → Candidate**: `candidate_invitations.candidate_id` = `job_seeker_profiles.id`

## Implementation Details

### Frontend Components

#### HiringProcessPage.jsx
- **Location**: `src/pages/v4/HiringProcessPage.jsx`
- **Purpose**: Main page for managing the hiring process workflow
- **Key Features**:
  - Fetches job details and matched candidates
  - Manages invitation state
  - Displays different hiring steps (Job Details, Recommended, Invited, etc.)

### Key Functions

#### 1. `inviteCandidate(candidateId)`
```javascript
const inviteCandidate = async (candidateId) => {
  // Check for existing invitation
  const { data: existingInvitation } = await supabase
    .from('candidate_invitations')
    .select('id')
    .eq('job_id', jobId)
    .eq('candidate_id', candidateId)
    .eq('employer_id', user.id) // Uses user.id, not company.id
    .single();

  if (existingInvitation) {
    toast.error('Candidate has already been invited');
    return;
  }

  // Insert new invitation
  const { data, error } = await supabase
    .from('candidate_invitations')
    .insert({
      job_id: jobId,
      candidate_id: candidateId,
      employer_id: user.id, // Uses user.id, not company.id
      status: 'invited'
    })
    .select()
    .single();

  // Update UI and show success message
  toast.success('Candidate invited successfully!');
  // Refresh invited candidates list...
};
```

#### 2. `fetchInvitedCandidates()`
```javascript
const fetchInvitedCandidates = async () => {
  const { data, error } = await supabase
    .from('candidate_invitations')
    .select(`
      *,
      candidate:job_seeker_profiles!candidate_invitations_candidate_id_fkey (
        id,
        headline,
        summary,
        experience_years,
        current_location,
        skills,
        languages,
        target_salary_range,
        ai_generated_summary,
        profiles (
          id,
          full_name,
          avatar_url,
          phone
        )
      )
    `)
    .eq('job_id', jobId)
    .eq('employer_id', user.id) // Uses user.id, not company.id
    .order('created_at', { ascending: false });
};
```

## Important Notes

### Foreign Key Usage
- **`employer_id`** in `candidate_invitations` should use `user.id` (not `company.id`)
- This is because `employer_profiles.id` = `user.id` (same value)
- The foreign key constraint expects `employer_profiles.id`, which is the user's ID

### Data Flow
1. **Employer clicks "Invite"** on a candidate in the Recommended section
2. **System checks** if invitation already exists
3. **System inserts** new invitation record with `employer_id = user.id`
4. **UI updates** to show the candidate in the Invited section
5. **Real-time updates** reflect the change immediately

### Error Handling
- **Duplicate invitations**: Prevented by checking existing records
- **Missing data**: Validates `jobId`, `user.id`, and `candidateId` before insertion
- **Database errors**: Caught and displayed as user-friendly toast messages

## Security

### Row Level Security (RLS)
- Employers can only view their own invitations
- Employers can only create invitations for themselves
- Employers can only update their own invitations

### Policies
```sql
CREATE POLICY "Employers can view their own invitations" ON public.candidate_invitations
    FOR SELECT USING (auth.uid() = employer_id);

CREATE POLICY "Employers can create invitations" ON public.candidate_invitations
    FOR INSERT WITH CHECK (auth.uid() = employer_id);

CREATE POLICY "Employers can update their own invitations" ON public.candidate_invitations
    FOR UPDATE USING (auth.uid() = employer_id);
```

## Usage

### For Employers
1. Navigate to a job's hiring process page
2. Go to the "Recommended" tab to see AI-matched candidates
3. Click "Invite" on candidates they want to invite
4. View invited candidates in the "Invited" tab
5. Track responses and manage the hiring workflow

### For Developers
1. Ensure the `candidate_invitations` table exists with correct foreign keys
2. Use `user.id` (not `company.id`) for `employer_id` field
3. Handle duplicate invitation attempts gracefully
4. Implement proper error handling and user feedback

## Migration
Run the migration file `database/migrations/004_create_candidate_invitations_table.sql` to create the table with proper structure and security policies.
